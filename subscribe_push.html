<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Iscrizione Push VAPID</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 480px;
      width: 100%;
      padding: 40px;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 32px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .steps {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }
    
    button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    button:hover:before {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .step-number {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    
    .log-container {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      min-height: 140px;
      border: 2px solid #e9ecef;
      position: relative;
    }
    
    .log-title {
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    #log {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #495057;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
    }
    
    .success {
      color: #28a745;
    }
    
    .error {
      color: #dc3545;
    }
    
    .icon {
      font-size: 20px;
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 24px;
      }
      
      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÅ Promozioni</h1>
    <p class="subtitle">Clicca il pulsante per ricevere le nostre promozioni</p>
    
    <div class="steps">
      <button id="btnSubscribe">
        <span style="flex: 1; text-align: center;">üéÅ Attiva Promozioni</span>
      </button>
    </div>
    
    <div class="log-container">
      <div class="log-title">Console</div>
      <pre id="log">Pronto. In attesa di istruzioni...</pre>
    </div>
  </div>

  <script>
    const publicKey = 'BNSoqC0lzx8detHtR_jr4Lst5InrPtNCoGluLoN-ZFabNPBf_uXxS72pRY3r9Ybj0fLl9keF2BPbOcNflBt8kRY';
    const logEl = document.getElementById('log');
    
    function log(msg, obj, type = 'info') {
      const text = obj ? msg + '\n' + JSON.stringify(obj, null, 2) : msg;
      logEl.textContent = text;
      logEl.className = type;
      console.log(msg, obj || '');
    }
    
    async function registerSw() {
      if (!('serviceWorker' in navigator)) {
        return log('‚ùå Service Worker non supportato dal browser', null, 'error');
      }
      
      log('‚è≥ Registrazione Service Worker in corso...');
      const reg = await navigator.serviceWorker.register('/app/ristorantedamimmo/PRENOTAZIONI/sw-toilet-001.js', { scope: '/app/ristorantedamimmo/PRENOTAZIONI/' });
      log('‚úÖ Service Worker registrato con successo!\n\nScope: ' + reg.scope, null, 'success');
    }
    
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    
    async function subscribe() {
      // Step 1: Registra Service Worker
      if (!('serviceWorker' in navigator)) {
        return log('‚ùå Service Worker non supportato dal browser', null, 'error');
      }
      
      log('‚è≥ Registrazione Service Worker...');
      const reg = await navigator.serviceWorker.register('sw-toilet-001.js', { scope: './' });
      log('‚úÖ Service Worker registrato\n\n‚è≥ Richiesta permessi...');
      
      // Step 2: Verifica permessi
      if (Notification.permission === 'denied') {
        return log('‚ùå Permesso negato\n\nRipristina le autorizzazioni nelle impostazioni del browser.', null, 'error');
      }
      
      // Step 3: Iscrizione push
      await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey),
      });
      
      log('‚úÖ Iscrizione creata\n\n‚è≥ Salvataggio nel database...');
      
      // Step 4: Salva nel database
      await fetch('push_register_vapid.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          subscription: sub.toJSON()
        })
      });
      
      log('‚úÖ Promozioni attivate con successo!\n\nRiceverai le nostre offerte speciali.', null, 'success');
    }
    
    document.getElementById('btnSubscribe').onclick = () => {
      subscribe().catch(e => log('‚ùå Errore:\n\n' + e.message, null, 'error'));
    };
  </script>
</body>
</html>